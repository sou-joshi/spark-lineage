<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Column Lineage</title>
  <link rel="stylesheet" href="/static/style.css"/>
  <script src="/static/force_graph.js"></script>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <a class="btn" href="/">Home</a>
      <a class="btn" href="/ai?g={{graph_key}}">AI demo</a>
      <span class="badge">Column</span>
      <span style="font-weight:800">{{column}}</span>
      <span class="badge">Graph: {{graph_key}}</span>
    </div>
    <span class="hint">scroll=zoom • drag bg=pan • drag node=move • click edge=evidence</span>
  </div>

  
<div class="controls">
  <span class="chip"><span class="hint">Mode</span>
    <select id="mode">
      <option value="all">Up + Down</option>
      <option value="up">Upstream</option>
      <option value="down">Downstream</option>
    </select>
  </span>

  <span class="chip"><span class="hint">Depth</span>
    <select id="depth">
      <option value="1">1</option>
      <option value="2" selected>2</option>
      <option value="3">3</option>
      <option value="4">4</option>
    </select>
  </span>

  <span class="chip">
    <label class="hint" style="display:flex;gap:8px;align-items:center;cursor:pointer">
      <input id="lanes" type="checkbox" checked/>
      Swimlanes
    </label>
  </span>

  <a class="btn" id="recenter" href="#">Re-center</a>
  <a class="btn" id="relax" href="#">Auto-layout</a>
  <span class="hint">Tips: <span class="kbd">wheel</span> zoom • <span class="kbd">drag</span> pan • <span class="kbd">drag node</span> move • hover highlights paths</span>
</div>
<div class="grid">

    <div class="card"><div id="graph"></div></div>
    <div class="card" id="panel"></div>
  </div>
</div>

<script>
const column="{{column}}";
const graphKey="{{graph_key}}";
const panel=document.getElementById("panel");

function pill(c){
  c=(typeof c==="number")?c:0.5;
  if(c>=0.8) return `<span class="pill good">conf ${c.toFixed(2)}</span>`;
  if(c>=0.6) return `<span class="pill accent">conf ${c.toFixed(2)}</span>`;
  return `<span class="pill warn">conf ${c.toFixed(2)}</span>`;
}
function setPanel(html){panel.innerHTML=html;}

function renderDerivations(view){
  const edges=(view.graph.edges||[]).filter(e=>e.edge_type==="column" && e.v===("col:"+column));
  const incoming=edges;
  const rows=incoming.map(e=>{
    const from=(e.u||"").replace("col:","");
    const tr=e.transformation||{};
    const kind=tr.kind||"expr";
    const udf=tr.udf?`<span class="badge">UDF</span> <b>${tr.udf}</b>`:"";
    const expr=tr.expr||e.evidence||"—";
    return `<div class="card" style="margin-top:10px;border-radius:12px;padding:10px">
      <div class="hint">Derived from</div>
      <div><a href="/lineage/column?column=${encodeURIComponent(from)}&g=${encodeURIComponent(graphKey)}"><b>${from}</b></a></div>
      <div style="margin-top:6px">${udf} <span class="badge">${kind}</span></div>
      <pre style="margin-top:8px">${expr}</pre>
      <div style="margin-top:6px">${pill(e.confidence)}</div>
    </div>`;
  }).join("");
  return rows || `<div class="hint" style="margin-top:8px">No derivation edges captured (pass-through or not logged).</div>`;
}

const graph=LineageGraph.createGraph(document.getElementById("graph"),{
  onNodeClick:(n)=>{
    if(n.id.startsWith("ds:")) location.href="/lineage/table/"+encodeURIComponent(n.id.slice(3))+"?g="+encodeURIComponent(graphKey);
    if(n.id.startsWith("col:")) location.href="/lineage/column?column="+encodeURIComponent(n.id.slice(4))+"&g="+encodeURIComponent(graphKey);
  },
  onEdgeClick:(e)=>{
    setPanel(`
      <div class="panel-title">Edge</div>
      <div class="kv"><div class="k">Type</div><div>${e.edge_type}</div></div>
      <div class="kv"><div class="k">From</div><div><code>${e.u}</code></div></div>
      <div class="kv"><div class="k">To</div><div><code>${e.v}</code></div></div>
      <div class="kv"><div class="k">Confidence</div><div>${pill(e.confidence)}</div></div>
      <div class="panel-title" style="margin-top:10px">Evidence</div>
      <pre>${(e.evidence||"—")}</pre>
    `);
  },
  onBgClick:()=> setPanel(`<div class="panel-title">Column</div><div><b>${column}</b></div><div class="hint">Click nodes/edges to explore lineage.</div>`)
});

async function loadGraph(){
  const depth=document.getElementById("depth").value;
  const mode=document.getElementById("mode").value;
  const res=await fetch(`/api/column?column=${encodeURIComponent(column)}&depth=${depth}&mode=${mode}&g=${encodeURIComponent(graphKey)}`);
  const view=await res.json();
  graph.setData(view.graph);
  setPanel(`<div class="panel-title">Column</div><div><b>${column}</b></div><div class="hint">Graph source: <code>${view.eventlog}</code></div><div class="panel-title" style="margin-top:12px">Derivations</div>${renderDerivations(view)}`);
}

document.getElementById("depth").addEventListener("change", loadGraph);
document.getElementById("mode").addEventListener("change", loadGraph);
document.getElementById("recenter").addEventListener("click",(e)=>{e.preventDefault(); graph.center();});
document.getElementById("relax").addEventListener("click",(e)=>{e.preventDefault(); graph.startSim(); setTimeout(()=>graph.stopSim(), 1500);});


const lanesToggle = document.getElementById("lanes");
if (lanesToggle) {
  lanesToggle.addEventListener("change", ()=>{
    graph.setLanesEnabled(lanesToggle.checked);
  });
}

const findInput = document.getElementById("find");
const findBtn = document.getElementById("findBtn");
if (findBtn && findInput) {
  findBtn.addEventListener("click",(e)=>{
    e.preventDefault();
    const q = findInput.value.trim();
    if(!q) return;
    const hit = graph.focusNodeByName(q);
    if(!hit) {
      // fallback: try navigate as dataset
      location.href="/lineage/table/"+encodeURIComponent(q)+"?g="+encodeURIComponent(graphKey);
    }
  });
  findInput.addEventListener("keydown",(e)=>{
    if(e.key==="Enter") findBtn.click();
  });
}

loadGraph();
</script>
</body>
</html>