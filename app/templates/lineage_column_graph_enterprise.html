<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Column Lineage</title>
  <link rel="stylesheet" href="/static/style.css"/>
  <script src="/static/force_graph.js"></script>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <a class="btn" href="/">Home</a>
      <span class="badge">Column</span>
      <span style="font-weight:800">{{column}}</span>
      <span class="badge">Graph: {{graph_key}}</span>
    </div>
    <span class="hint">scroll=zoom • drag bg=pan • drag node=move • click edge=evidence</span>
  </div>

  <div class="controls">
    <label class="hint">Mode</label>
    <select id="mode">
      <option value="all">Up + Down</option>
      <option value="up">Upstream</option>
      <option value="down">Downstream</option>
    </select>

    <label class="hint">Depth</label>
    <select id="depth">
      <option value="1">1</option>
      <option value="2" selected>2</option>
      <option value="3">3</option>
      <option value="4">4</option>
    </select>

    <a class="btn" id="recenter" href="#">Re-center</a>
    <a class="btn" id="relax" href="#">Auto-layout</a>
  </div>

  <div class="grid">
    <div class="card"><div id="graph"></div></div>
    <div class="card" id="panel"></div>
  </div>
</div>

<script>
const column="{{column}}";
const graphKey="{{graph_key}}";
const panel=document.getElementById("panel");

function pill(c){
  c=(typeof c==="number")?c:0.5;
  if(c>=0.8) return `<span class="pill good">conf ${c.toFixed(2)}</span>`;
  if(c>=0.6) return `<span class="pill accent">conf ${c.toFixed(2)}</span>`;
  return `<span class="pill warn">conf ${c.toFixed(2)}</span>`;
}
function setPanel(html){panel.innerHTML=html;}

const graph=LineageGraph.createGraph(document.getElementById("graph"),{
  onNodeClick:(n)=>{
    if(n.id.startsWith("ds:")) location.href="/lineage/table/"+encodeURIComponent(n.id.slice(3))+"?g="+encodeURIComponent(graphKey);
    if(n.id.startsWith("col:")) location.href="/lineage/column?column="+encodeURIComponent(n.id.slice(4))+"&g="+encodeURIComponent(graphKey);
  },
  onEdgeClick:(e)=>{
    setPanel(`
      <div class="panel-title">Edge</div>
      <div class="kv"><div class="k">Type</div><div>${e.edge_type}</div></div>
      <div class="kv"><div class="k">From</div><div><code>${e.u}</code></div></div>
      <div class="kv"><div class="k">To</div><div><code>${e.v}</code></div></div>
      <div class="kv"><div class="k">Confidence</div><div>${pill(e.confidence)}</div></div>
      <div class="panel-title" style="margin-top:10px">Evidence</div>
      <pre>${(e.evidence||"—")}</pre>
    `);
  },
  onBgClick:()=> setPanel(`<div class="panel-title">Column</div><div><b>${column}</b></div><div class="hint">Click nodes/edges to explore lineage.</div>`)
});

async function loadGraph(){
  const depth=document.getElementById("depth").value;
  const mode=document.getElementById("mode").value;
  const res=await fetch(`/api/column?column=${encodeURIComponent(column)}&depth=${depth}&mode=${mode}&g=${encodeURIComponent(graphKey)}`);
  const view=await res.json();
  graph.setData(view.graph);
  setPanel(`<div class="panel-title">Column</div><div><b>${column}</b></div><div class="hint">Graph source: <code>${view.eventlog}</code></div>`);
}

document.getElementById("depth").addEventListener("change", loadGraph);
document.getElementById("mode").addEventListener("change", loadGraph);
document.getElementById("recenter").addEventListener("click",(e)=>{e.preventDefault(); graph.center();});
document.getElementById("relax").addEventListener("click",(e)=>{e.preventDefault(); graph.startSim(); setTimeout(()=>graph.stopSim(), 1500);});

loadGraph();
</script>
</body>
</html>